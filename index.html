<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>WOI ‚Äì Mijn Personage</title>
  <meta name="theme-color" content="#0c2630"/>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root { --bg:#0b1a22; --card:#0f2430; --text:#e8f4f7; --muted:#9fb6bd; --accent:#3dd1c0; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    h1,h2{margin:.2rem 0 .6rem} h1{font-size:1.35rem} h2{font-size:1.1rem}
    .wrap{max-width:980px;margin:0 auto;padding:14px}
    .grid{display:grid;gap:12px} .two{grid-template-columns:1fr;}.pill{display:inline-block;border:1px solid rgba(255,255,255,.15);padding:.25rem .6rem;border-radius:999px;margin:.15rem .25rem 0 0;white-space:nowrap}
    @media (min-width:840px){.two{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.22)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.right{justify-content:flex-end}
    .small{font-size:.9rem}.muted{color:var(--muted)} .warn{color:#ffdf80}
    button{background:#173743;color:#dff7fb;border:none;padding:8px 12px;border-radius:10px;cursor:pointer}
    button.primary{background:#2db9a8;color:#062b33} button:disabled{opacity:.5;cursor:not-allowed}
    select{background:#0f2a35;color:#eaf7fa;border:1px solid rgba(255,255,255,.15);padding:8px;border-radius:10px}
    .ring{width:54px;height:54px;border-radius:999px;display:grid;place-items:center;background:conic-gradient(var(--accent) 0deg, rgba(255,255,255,.15) 0 360deg);box-shadow:0 2px 8px rgba(0,0,0,.25)}
    .ring span{font-size:.75rem;color:#062b33;font-weight:700}
    .kpi{justify-content:space-between}
    .mapframe{width:100%;height:360px;border:0;border-radius:12px}.mapframe.small{height:300px}
    details{background:#0a1e27;border:1px solid rgba(255,255,255,.08);padding:8px 10px;border-radius:10px}
    summary{cursor:pointer} .qs{margin:.4rem 0 0 .2rem;padding-left:1rem}.qs li{margin:.2rem 0}
    #diag{position:fixed;right:10px;bottom:10px;background:#06151b;color:#bde8ef;border:1px solid rgba(255,255,255,.15);padding:8px 10px;border-radius:10px;font-size:.8rem;opacity:.9;z-index:9999;display:none}
    #toast{position:fixed;left:50%;bottom:76px;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;padding:10px 14px;border-radius:12px;z-index:9999}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row right">
      <span class="pill">PWA: <b id="cacheState">Niet ge√Ønstalleerd</b></span>
      <div class="ring" id="progressRing"><span id="progressText">0/4</span></div>
    </div>

    <h1>WOI ‚Äì Mijn Personage</h1>

    <div class="grid two">
      <section class="card">
        <h2>Jouw personage</h2>
        <div class="small muted">Je mag alleen <b>aan de startlocatie</b> een personage kiezen of wijzigen. Daarna wordt je keuze vastgezet.</div>
        <div id="pcInfo" class="small muted" style="margin:8px 0">Laden‚Ä¶</div>
        <div id="pcChooser" class="row small"></div>
        <div class="row" style="gap:8px;margin-top:6px">
          <button id="regenBtn">üé≤ Willekeurig</button>
          <button id="savePcBtn" class="primary">‚úÖ Bevestig keuze</button>
          <button id="exportBtn">üíæ Exporteer voortgang</button>
        </div>
        <div class="small muted" style="margin-top:6px">
          Tip: installeer via browser-menu en open minstens √©√©n keer online; daarna werkt alles offline.
        </div>
      </section>

      <section class="card">
        <h2>Locatiestatus</h2>
        <div class="small muted" id="permNote"></div>
        <div class="row kpi"><div>üìç (¬± <span id="acc">‚Äî</span> m)</div><div></div></div>
        <div class="row kpi"><div>üéØ Dichtstbijzijnde stop:</div><div><b id="closest">‚Äî</b></div></div>
        <div class="row kpi"><div>‚ÜîÔ∏è Afstand:</div><div><b id="dist">‚Äî</b> m</div></div>
        <div class="row kpi"><div>üõ°Ô∏è Straal:</div><div><b id="radius">‚Äî</b> m</div></div>
        <div class="row" style="gap:8px;margin-top:8px">
          <button id="startBtn" class="primary">‚ñ∂Ô∏è Start locatie</button>
          <button id="stopBtn">‚è∏Ô∏è Pauzeer</button>
          <button id="demoBtn">üß™ Demo-nabij</button>
        </div>
        <div class="small muted">Status: <span id="geoState">Uit</span> ‚Ä¢ Co√∂rdinaten: <span id="coords">‚Äî</span></div>
      </section>
    </div>

    <section class="card" style="margin-top:12px">
      <h2>Ontgrendelde verhalen</h2>
      <div id="unlockList" class="small muted">Nog niets ontgrendeld.</div>
    </section>

    <section class="card" style="margin-top:12px">
      <h2>Stops (overzicht)</h2>
      <div id="stopsList" class="small"></div>
    </section>

    <section class="card" style="margin-top:12px">
      <h2>Kaart</h2>
      <div class="small muted">Routekaart (My Maps) en live positie (werkt online). Offline blijft de app functioneren zonder kaart.</div>
      <div class="grid" style="grid-template-columns:1fr;gap:10px">
        <iframe id="routeMap" class="mapframe" src=""></iframe>
        <iframe id="liveMap" class="mapframe small" src=""></iframe>
      </div>
      <div class="row small" style="margin-top:8px">
        <a id="openInMaps" href="#" target="_blank" rel="noopener">üìç Open je positie in Google Maps</a>
      </div>
    </section>

    <div class="row right" style="margin-top:12px">
      <button id="installHint">üì≤ Installeer</button>
      <button id="resetBtn">üßπ Reset app</button>
    </div>
  </div>

  <div id="diag"></div>

  <!-- DATA -->
  <script id="scenario-data" type="application/json">{
    "meta": {
      "title": "WOI ‚Äì Mijn Personage",
      "radiusDefaultMeters": 200,
      "startStopId": "start_menenpoort",
      "endStopId": "end_menenpoort",
      "requiredStops": ["new_irish_farm","langemark","tyne_cot","passchendaele_museum"],
      "myMapsEmbedUrl": "https://www.google.com/maps/d/embed?mid=1PX9PLdEburE2dqbKbAj2C44SiCjtGSc&hl=nl&ehbc=2E312F"
    },
    "stops": [
      {"id":"start_menenpoort","naam":"Start: Menenpoort (Ieper)","lat":50.851003,"lng":2.890939,"radius":140,
        "vragen":["Welke naam of inscriptie raakte je en waarom?","Wat verwacht je vandaag te leren?"]},
      {"id":"new_irish_farm","naam":"Stop 1: New Irish Farm Cemetery","lat":50.872890,"lng":2.897360,"radius":180,
        "vragen":["Wat viel je op aan de namen of symbolen op de graven?","Welke link hoor jij tussen dit landschap en het verhaal van jouw personage?"]},
      {"id":"langemark","naam":"Stop 2: Studentenfriedhof Langemark","lat":50.915300,"lng":2.916300,"radius":200,
        "vragen":["Wat betekent het voor jou dat hier vooral jonge studenten liggen?","Hoe verandert dit jouw kijk op ‚Äòde vijand‚Äô?"]},
      {"id":"tyne_cot","naam":"Stop 3: Tyne Cot Cemetery","lat":50.887000,"lng":2.999300,"radius":220,
        "vragen":["Wat zegt de schaal van deze plek over de slag hier?","Welke zin uit het verhaal bleef hangen en waarom?"]},
      {"id":"passchendaele_museum","naam":"Stop 4: Memorial Museum Passchendaele","lat":50.898700,"lng":3.000700,"radius":180,
        "vragen":["Wat doet het met je om objecten uit de oorlog achter glas te zien?","Welke vraag zou jij willen stellen aan iemand uit die tijd?"]},
      {"id":"end_menenpoort","naam":"Einde: Menenpoort (Ieper)","lat":50.851003,"lng":2.890939,"radius":140,
        "vragen":["Wat neem je mee uit de verhalen?","Voor wie wil jij hier even stilstaan?"]}
    ],
    "personages": [
      {"id":"aminata_diop","naam":"Aminata Diop","herkomst":"Saint-Louis, Senegal","leeftijd":22,"rol":"Verpleegster (Rode Kruis)","bio":"Verzorgde gewonden in veldhospitalen rond Ieper.","verhalen":{
        "start_menenpoort":"Ik ben Aminata, dochter van een kleermaker uit Saint-Louis. Toen de oorlog kwam, zocht het Rode Kruis handen die konden verzorgen en harten die niet te snel braken. Ik dacht dat brieven schrijven voor gewonden mijn zwaarste taak zou zijn, tot ik leerde hoe stilte in een tent zwaarder kan wegen dan ieder verband.",
        "new_irish_farm":"De Ierse jongens vroegen eerst om thee. Daarna om tijd. Loopgraafvoet, schrammen, koorts ‚Äî en altijd modder. Ik leerde voeten drogen met zachte doeken en de blik af te wenden wanneer schaamte harder prikte dan jodium.",
        "langemark":"We ruilden steriele doeken met een Duitse verpleger, kort en woordeloos. Aan beide kanten waren de handen even moe en even menselijk. In de schemer van de verbandtent leek het front heel even een gangpad in een ziekenhuis.",
        "tyne_cot":"De brancards bleven komen. Morfine was schaars, hoop nog schaarser. Ik schreef voor wie niet meer kon: ‚ÄòLieve moeder, maak u geen zorgen.‚Äô De jongen die het dicteerde kneep mijn hand tot de woorden ophielden.",
        "passchendaele_museum":"Achter glas blinken instrumenten schoon, maar ik hoor er de zenuwachtige ademhaling bij. Ik zie polsbandjes, etiketten, flessenkurken ‚Äî kleine beloftes dat we ons best deden, ook als het niet genoeg was.",
        "end_menenpoort":"Hier, tussen namen zonder graf, denk ik aan alle brieven die nooit verstuurd raakten. Ik vouw mijn herinneringen dicht zoals ik ooit gaas dichtvouwde: zorgvuldig, met de wens dat het iemand minder pijn doet."
      }},
      {"id":"youssef_ben_salah","naam":"Youssef ben Salah","herkomst":"F√®s, Marokko","leeftijd":19,"rol":"Tirailleur (Frans)","bio":"Kwam in 1917 naar het Westelijk Front als versterking.","verhalen":{
        "start_menenpoort":"Ik ben Youssef, zoon van een leerbewerker. Vrijwilliger uit F√®s, overtuigd dat moed overal dezelfde taal spreekt. In Ieper voelde ik me klein tussen bogen en namen; ik herkende geen enkel woord, maar ik begreep de stilte.",
        "new_irish_farm":"We ploeterden door aarde die aan je laarzen trok alsof ze je wilde houden. Het bevel was eenvoudig: vooruit. Ik droeg munitie, water, soms mijn eigen angst, en leerde dat zingen in het Arabisch ook warmte kan geven in een Vlaamse regenbui.",
        "langemark":"Een Duitse gevangene vroeg om brood. Ik gaf hem een stuk en hij gaf me een woord terug ‚Äî ‚Äòdanke‚Äô. Het klonk vreemd in mijn mond, maar menselijk in mijn oren. Voor heel even leek het front geen grens.",
        "tyne_cot":"We telden niet meer in dagen maar in granaten. Een vriend verdween in rook zonder afscheid. Ik schreef zijn naam op een papiertje en stopte het bij mijn Koran, alsof papier kon bewaren wat de modder rooft.",
        "passchendaele_museum":"Een bajonet achter glas is lichter dan in je handen. Ik raak het glas niet aan; sommige dingen houd je beter op afstand, anders kom je ze weer tegen in je slaap.",
        "end_menenpoort":"Als ik terugkijk, vraag ik niet waarom ik bleef leven. Ik vraag wat ik met dat leven zal doen zodat zijn naam, die op mijn papiertje staat, blijft bestaan."
      }},
      {"id":"stanislaw_nowak","naam":"Stanis≈Çaw Nowak","herkomst":"Galici√´","leeftijd":21,"rol":"Artilleriehelper","bio":"Boerenzoon met een liefde voor techniek.","verhalen":{
        "start_menenpoort":"Stanis≈Çaw, zoon van een smid. Ik werd opgeleid bij de artillerie omdat ik snel begreep hoe katrollen en hulsliften werkten. Onder deze poort klinkt de stad als een grote klok: iedere echo tikt een naam aan.",
        "new_irish_farm":"Het verzetten van een houwitser lijkt op ploegen: langzaam, samen, en met blaren. Ik leerde schatten zonder meetlint, voelen zonder te kijken. Soms wist ik aan de trilling al genoeg.",
        "langemark":"Tussen twee beschietingen durfde iemand viool te spelen. Een melodie zonder vlag of rang. Even telde ik geen afstand in meters maar in maten.",
        "tyne_cot":"Elke granaat heeft een nummer, maar geen geweten. Ik droeg hulzen weg en vroeg me af hoeveel stilte ze zouden achterlaten. Als de batterij zweeg, hoorde ik mijn hart eindelijk in een normaal tempo.",
        "passchendaele_museum":"Instrumenten met naalden en wijzers fascineren me nog steeds. Ze meten, maar ze begrijpen niet. Misschien is dat beter zo.",
        "end_menenpoort":"Ik wil na de oorlog machines maken die bouwen. Tandwielen die graan malen. Krachten die mensen optillen in plaats van neerhalen."
      }},
      {"id":"margot_vandamme","naam":"Margot Vandamme","herkomst":"Ieper, Belgi√´","leeftijd":18,"rol":"Burger ‚Äì brievenschrijfster","bio":"Schreef brieven voor gewonden die zelf niet meer konden.","verhalen":{
        "start_menenpoort":"Ik ben Margot, dochter van een kruidenier. In de verbandpost vroeg een verpleger of ik wilde helpen schrijven. ‚ÄòZij dicteren, jij noteert.‚Äô Soms waren het drie woorden. Soms een hele avond stilte.",
        "new_irish_farm":"Een Ierse jongen lachte om mijn accent toen ik ‚Äòma‚Äô voorlas. Daarna beet hij op zijn lip om het huilen tegen te houden. Ik zette mijn hand op de rand van zijn bed en deed alsof we allebei sterk waren.",
        "langemark":"De zwarte kruisen stonden dicht bij elkaar. Ik dacht aan hoe klein mensen worden als je ze alleen nog als naam leest. Ik stak een lintje in mijn zak, niet wetend voor wie ik het bewaarde.",
        "tyne_cot":"Een Canadese verpleegster gaf me een stukje blauw lint. ‚ÄòVoor moed,‚Äô zei ze. Ik had geen geweer, maar ik droeg het toch.",
        "passchendaele_museum":"In een vitrine ligt een veldfles zoals mijn broer er een had. Ik zie mijn eigen gezicht in het glas weerspiegeld en vraag me af of herinneringen zwaarder worden of lichter door de jaren.",
        "end_menenpoort":"Ik leg het lintje neer zonder naam. Voor de jongen, voor mijn broer, voor wie nooit werd voorgelezen. Soms is herdenken niets anders dan hardop blijven schrijven."
      }},
      {"id":"harinder_singh","naam":"Harinder Singh","herkomst":"Punjab, Brits-Indi√´","leeftijd":23,"rol":"Sikh infanterist","bio":"Diende in het Britse leger, hield vast aan geloof en turban.","verhalen":{
        "start_menenpoort":"Ik ben Harinder. Mijn vader vertelde dat eer rechtop begint: in je rug en in je turban. Ik stapte aan boord omdat dienstplicht hier plicht heet en thuis eer.",
        "new_irish_farm":"Modder maakt geen onderscheid. Ik deelde mijn brood en kreeg een grap terug. Voor even proefde ik thuis in een lach die ik niet helemaal begreep.",
        "langemark":"Een kamerad vroeg of mijn haar nooit lastig was. Ik zei dat geloof je rug recht houdt, ook als je handen trillen. Hij knikte en reikte me draad aan om mijn turban opnieuw te winden.",
        "tyne_cot":"Een scherf scheurde stof, niet huid. Ik dankte zacht, streek mijn tulband glad en keek of iedereen nog stond. Je telt je zegeningen soms in inches.",
        "passchendaele_museum":"Een uniformpop staart de zaal in. Ik raak niets aan. Ik denk aan handen wassen met weinig water en toch proberen schoon te blijven van binnen.",
        "end_menenpoort":"Ik spreek een kort gebed, niet voor overwinning, maar voor rust. Voor wie viel, en voor wie bleef dragen."
      }},
      {"id":"elsa_stein","naam":"Elsa Stein","herkomst":"Keulen, Duitsland","leeftijd":20,"rol":"Geneeskundestudente (vrijwilliger)","bio":"Kreeg opleiding in noodhospitaal net over de grens.","verhalen":{
        "start_menenpoort":"Elsa, tweedejaars geneeskunde. Ik dacht dat anatomieboeken me zouden beschermen tegen echte wonden. De oorlog leerde me dat kennis helpt, maar dat handen het moeten doen.",
        "new_irish_farm":"In de ochtend oefenden we hechtingen op sinaasappels. In de middag niet meer. Ik telde naalden alsof tellen controle gaf.",
        "langemark":"Mijn accent maakte me verdacht. Toch hield iemand het gordijn open terwijl ik werkte. Ik keek niet op. Pijn heeft geen uniform.",
        "tyne_cot":"Koorts, pols, adem ‚Äî ritme tegen paniek. Soms hielp het een mens te vertellen wat ik aan het doen was, alsof uitleg zelf een medicijn was.",
        "passchendaele_museum":"Instrumenten liggen stil, maar ik hoor nog de snelle adempjes van wie bang is. Ik hoop dat niemand ooit zal denken dat we niet probeerden.",
        "end_menenpoort":"Ik keer terug naar de studie met handen die te veel hebben aangeraakt en een hart dat niet wil verharden. Misschien is dat genoeg."
      }},
      {"id":"mehmet_arslan","naam":"Mehmet Arslan","herkomst":"Ankara, Ottomaanse Rijk","leeftijd":26,"rol":"Sappeur","bio":"Groef en timmerde, vaak dichterbij dan goed was.","verhalen":{
        "start_menenpoort":"Mehmet, zoon van een timmerman. Ik werd sappeur omdat ik recht kan zagen, ook als de grond beeft. Hier kijk ik naar bogen en denk ik aan draagkracht: wat houdt en wat breekt.",
        "new_irish_farm":"Steunbalken kraken eerlijk; ze liegen niet. Ik klopte ze vast met een ritme dat luider was dan mijn gedachten.",
        "langemark":"Tabak ruilen voor spijkers lijkt dwaas, totdat je dakbalken wil die blijven hangen. Ik stak een extra nagel waar niemand hem zag, gewoon voor de zekerheid.",
        "tyne_cot":"Ondergronds klinkt oorlog als een verre onweer. Je leert luisteren naar zand dat beweegt, naar planken die ademen.",
        "passchendaele_museum":"Een maquette van loopgraven ziet er netjes uit. In het echt is niets netjes behalve de discipline om terug te komen als iets los zit.",
        "end_menenpoort":"Na dit alles wil ik huizen stutten die nooit meer hoeven te schuilen. Het is een bescheiden droom, maar hij draagt ver."
      }},
      {"id":"hua_zheng","naam":"Hua Zheng","herkomst":"Shandong, China","leeftijd":24,"rol":"Chinese Labour Corps","bio":"Arbeider aan wegen, sporen en logistiek.","verhalen":{
        "start_menenpoort":"Ik ben Hua. In mijn dorp zei men: ‚ÄòWie werkt met twee handen, reist ver.‚Äô Ik tekende voor arbeid, niet voor oorlog, en toch droeg ik haar elke dag.",
        "new_irish_farm":"Kratten sjouwen werd een lied zonder woorden: tillen, stappen, neerzetten, ademen. Aan het eind van de dag proefde ik stof, zout en soms een grap die overleefde.",
        "langemark":"Ik leerde ‚Äòdank u‚Äô zeggen met een vreemd accent en iemand leerde mij ‚Äòxie xie‚Äô terug. We lachten omdat we allebei fout zaten en toch begrepen wat bedoeld werd.",
        "tyne_cot":"We legden kiezels recht tussen witte stenen. Het gaf rust om iets te ordenen in een wereld die uit de maat was.",
        "passchendaele_museum":"Op een foto zie ik gezichten die op de mijne lijken, maar donkerder van de modder. Ik vraag me af of iemand onze namen zal herinneren als het werk klaar is.",
        "end_menenpoort":"Misschien is dit de plek waar arbeid ook herdenking wordt. Ik denk aan een weg die naar huis leidt, strak en vlak, zonder kraters."
      }},
      {"id":"aileen_omalley","naam":"Aileen O‚ÄôMalley","herkomst":"Cork, Ierland","leeftijd":19,"rol":"Veldtelefoniste","bio":"Onderhield lijnen onder gevaarlijk vuur.","verhalen":{
        "start_menenpoort":"Aileen, veldtelefoniste. Mijn werk was luisteren, knopen leggen en hopen dat stemmen elkaar bleven vinden. Ik leerde dat een rechte lijn soms de gevaarlijkste weg is.",
        "new_irish_farm":"Een lijn brak, natuurlijk net wanneer het dringend was. Ik knoopte met stijve vingers en bad dat de vonk niet langs mij koos om over te springen.",
        "langemark":"Aan de andere kant van de draad klonk iemand met een zwaar accent. ‚ÄòLinie vrij?‚Äô vroeg hij. ‚ÄòNog wel,‚Äô antwoordde ik. Voor even waren we alleen techniek.",
        "tyne_cot":"De stilste momenten zijn het luidst in je hoofd. Soms hield ik de koptelefoon net even van mijn oor, niet uit angst, maar om weer te kunnen tellen.",
        "passchendaele_museum":"De telefooncentrale in de vitrine ruikt vast niet meer naar bakeliet en zweet. Ik weet nog hoe de schakelaars aanvoelden, als kleine beslissingen.",
        "end_menenpoort":"‚ÄòLijn hersteld,‚Äô zeg ik zacht. Niet voor een officier, maar voor iedereen die nog iets wil zeggen tegen wie er niet meer is."
      }},
      {"id":"marcel_dupont","naam":"Marcel Dupont","herkomst":"Lille, Frankrijk","leeftijd":25,"rol":"Poilu (infanterist)","bio":"Doorstond de modder met droge humor.","verhalen":{
        "start_menenpoort":"Marcel hier. Ik hield van brood met te veel korst en grappen met te weinig punt. Toen we marcheerden, zei ik dat de modder bang voor mij was. Ze lachte niet terug.",
        "new_irish_farm":"We deelden sigaretten en schunnige liedjes, alsof lucht beter ademt met branie. De nacht was koud en de grappen warmden net genoeg.",
        "langemark":"Iemand tekende thuis in mijn notitieboekje. Een straat, een vrouw achter een raam. Als ik het dichtklapte, voelde ik haar niet meer roepen dat ik moest eten.",
        "tyne_cot":"‚Äî Hier neemt Louise, Marcels zus, over. Hij viel bij een aanval; de brief zei ‚Äòonmiddellijk‚Äô en ‚Äòzonder pijn‚Äô. Later vond ik zijn boekje terug, nat en toch leesbaar. Ik blader erin alsof hij nog even moet lachen om iets wat ik niet snap.",
        "passchendaele_museum":"Ik, Louise, sta hier en herken een gasmasker dat muf ruikt in mijn herinnering. Niet omdat ik het droeg, maar omdat Marcel erover schreef: dat je ademhalen dan ineens werk wordt.",
        "end_menenpoort":"Ik leg zijn naam tussen andere namen. Ik weet niet of hij bang was. Ik weet wel dat hij altijd zei dat modder bang voor hem was. Misschien heeft hij het gewonnen."
      }},
      {"id":"anna_kowalska","naam":"Anna Kowalska","herkomst":"≈Å√≥d≈∫, Polen","leeftijd":22,"rol":"Chauffeuse (ambulance)","bio":"Reed gewonden over hobbelige wegen naar hulp.","verhalen":{
        "start_menenpoort":"Anna, dochter van een wever. Ik leerde rijden op vrachtwagens die liever bleven staan. In oorlogstijd heet vooruitgang soms gewoon ‚Äòin z‚Äôn twee en hopen‚Äô.",
        "new_irish_farm":"Mijn lading ademde en kreunde. Bochten moesten zacht, anders deed ik meer kwaad dan goed. Ik praatte tegen de motor alsof hij een koppig paard was.",
        "langemark":"Een paard stond echt midden op de weg. Ik legde mijn hand op zijn hals en beloofde niets, en toch ging hij opzij. Een soldaat lachte dat ik talen sprak die hij niet kende.",
        "tyne_cot":"Banden plakken bij maanlicht is geduld oefenen. Ik telde tot honderd bij iedere slag van de pomp, zoals mijn moeder telt als ze bidt.",
        "passchendaele_museum":"De ambulance in de zaal is kleiner dan ik me herinner. Misschien ben ik groter geworden, of is het verleden altijd net te knus in vitrines.",
        "end_menenpoort":"Ik zet in gedachten de motor uit. Even niets dat trilt. Alleen adem, en de weg naar huis die stil voor me ligt."
      }}
    ]
  }</script>

  <!-- APP -->
  <script>
  (function(){
    const $=sel=>document.querySelector(sel);
    const showDiag = (msg) => { const d=$('#diag'); d.style.display='block'; d.textContent=String(msg).slice(0,400); };
    window.addEventListener('error', e=>showDiag('JS error: '+e.message));
    window.addEventListener('unhandledrejection', e=>showDiag('Promise error: '+(e.reason?.message||e.reason)));

    const DATA = JSON.parse(document.getElementById('scenario-data').textContent);
    const store={get(){try{return JSON.parse(localStorage.getItem('woi_state')||'{}')}catch{return{}}},set(v){localStorage.setItem('woi_state',JSON.stringify(v))}};
    const distanceMeters=(a,b)=>{const R=6371e3,œÜ1=a.lat*Math.PI/180,œÜ2=b.lat*Math.PI/180,dœÜ=(b.lat-a.lat)*Math.PI/180,dŒª=(b.lng-a.lng)*Math.PI/180;const s=Math.sin(dœÜ/2)**2+Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(dŒª/2)**2;return 2*R*Math.asin(Math.sqrt(s));};
    const pick=a=>a[Math.floor(Math.random()*a.length)];

    function toast(msg){ let t=document.getElementById('toast'); if(!t){ t=document.createElement('div'); t.id='toast'; document.body.appendChild(t);} t.textContent=msg; clearTimeout(t._h); t.style.display='block'; t._h=setTimeout(()=>{t.style.display='none'},2000); }

    function ensureCharacter(){
      const st=store.get(); const forced=new URLSearchParams(location.search).get('pc');
      if(forced && DATA.personages.some(p=>p.id===forced)){ st.pcId=forced; store.set(st); return st.pcId; }
      if(st.pcId && DATA.personages.some(p=>p.id===st.pcId)) return st.pcId;
      const pc=pick(DATA.personages); st.pcId=pc.id; store.set(st); return pc.id;
    }
    const currentPc=()=>DATA.personages.find(p=>p.id===store.get().pcId);

    function renderProfile(){
      const pc=currentPc(); if(!pc) return;
      const box=$('#pcInfo'); if(!box) return;
      box.innerHTML = `<div class="row">
        <div class="pill">üßë <b>${pc.naam}</b></div>
        <div class="pill">üéÇ ${pc.leeftijd} jaar</div>
        <div class="pill">üåç ${pc.herkomst}</div>
        <div class="pill">üéñÔ∏è ${pc.rol}</div>
      </div><p class="muted">${pc.bio}</p>`;
      renderCharacterChooser();
    }

    function renderCharacterChooser(){
      const st=store.get(); const el=$('#pcChooser'); if(!el) return;
      const options = DATA.personages.map(p=>`<option value="${p.id}" ${p.id===st.pcId?'selected':''}>${p.naam} (${p.leeftijd}) ‚Äî ${p.rol}</option>`).join('');
      const inside = window.__insideStart===true; const locked = !!st.lockedPc;
      el.innerHTML = `<select id="pcSelect" ${locked?'disabled':''} ${!inside&&!locked?'disabled':''}>${options}</select>
        <span class="pill ${locked?'ok':''}">${locked?'üîí Keuze vergrendeld': (inside? 'üü¢ Je kan hier je personage kiezen' : 'üîê Kiesbaar enkel aan de start')}</span>`;
    }

    function renderStops(){
      const cont=$('#stopsList'); if(!cont) return;
      const st=store.get(); const unlocked=new Set(st.unlocked||[]);
      cont.innerHTML = DATA.stops.map(s=>{
        const ok = unlocked.has(s.id); const isEnd = s.id===DATA.meta.endStopId;
        const icon = ok ? '‚úÖ' : (isEnd ? 'üîí' : '‚è≥');
        return `<span class="pill">${icon} ${s.naam}</span>`;
      }).join('');
    }

    function renderUnlocked(){
      const st=store.get(); const pc=currentPc(); const cont=$('#unlockList'); if(!cont) return;
      if(!st.unlocked||!st.unlocked.length){cont.innerHTML='<div class="muted">Nog niets ontgrendeld.</div>';return;}
      cont.innerHTML = st.unlocked.map(id=>{
        const stop = DATA.stops.find(s=>s.id===id);
        const txt = pc.verhalen?.[id];
        const qs = (stop?.vragen||[]);
        const qHtml = qs.length? `<div class="small" style="margin-top:6px"><b>Reflectie:</b><ul class="qs">${qs.map(q=>`<li>${q}</li>`).join('')}</ul></div>` : '';
        return `<details open>
          <summary>üìò ${stop?.naam||id} <button class="readBtn" data-read="${id}" title="Lees voor">üîä</button></summary>
          <div style="margin-top:6px">${txt||'<span class="muted">(Geen tekst)</span>'}</div>
          ${qHtml}
        </details>`;
      }).join('');
      renderProgress();
    }

    function renderProgress(){
      const st = store.get(); const req = DATA.meta.requiredStops||[];
      const done = (st.unlocked||[]).filter(id=>req.includes(id)).length;
      const total=req.length; const deg = total?(done/total)*360:0;
      const ring=$('#progressRing'), txt=$('#progressText');
      if(ring) ring.style.background = `conic-gradient(var(--accent) ${deg}deg, rgba(255,255,255,.15) 0 360deg)`;
      if(txt) txt.textContent = `${done}/${total}`;
    }

    // Speech
    let selectedVoice=null;
    function pickVoice(){ try{ const vs=speechSynthesis.getVoices(); selectedVoice = vs.find(v=>v.lang?.toLowerCase().startsWith('nl')) || vs.find(v=>v.lang?.toLowerCase().startsWith('en')) || vs[0]||null; }catch{} }
    function speakText(t){ if(!('speechSynthesis'in window)) return alert('Voorlezen niet ondersteund.'); speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(t); if(selectedVoice) u.voice=selectedVoice; u.lang=(selectedVoice&&selectedVoice.lang)||'nl-NL'; speechSynthesis.speak(u); }

    // Geoloc
    let watchId=null; window.__insideStart=false;
    function tryUnlock(best, acc){
      const effective = Math.max(0, best.d - (acc||0));
      if(effective <= best.radius){
        const st=store.get(); st.unlocked=st.unlocked||[];
        if(best.id===DATA.meta.endStopId){
          const req = new Set(DATA.meta.requiredStops);
          const haveAll = [...req].every(id=>st.unlocked.includes(id));
          if(!haveAll) return;
        }
        if(!st.unlocked.includes(best.id)){
          st.unlocked.push(best.id); store.set(st);
          renderUnlocked(); renderStops(); toast(`‚úÖ Ontgrendeld: ${best.name}`);
        }
      }
    }
    function updateLiveMap(lat,lng){
      const live=$('#liveMap'); if(live) live.src = `https://maps.google.com/maps?q=${lat},${lng}&z=15&output=embed`;
      const open=$('#openInMaps'); if(open) open.href=`https://maps.google.com/?q=${lat},${lng}`;
    }

    function startWatch(){
      if(!('geolocation'in navigator)){ $('#permNote').textContent='Geen geolocatie'; return; }
      $('#geoState').textContent='Actief';
      watchId = navigator.geolocation.watchPosition(pos=>{
        const {latitude,longitude,accuracy}=pos.coords;
        $('#coords').textContent = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
        $('#acc').textContent = Math.round(accuracy);
        const here={lat:latitude,lng:longitude};
        let best=null; let insideStart=false;
        for(const s of DATA.stops){
          const d = Math.round(distanceMeters(here,{lat:s.lat,lng:s.lng}));
          if(!best||d<best.d) best={id:s.id,name:s.naam,d,radius:(s.radius||DATA.meta.radiusDefaultMeters)};
          if(s.id===DATA.meta.startStopId){ insideStart = d <= (s.radius||DATA.meta.radiusDefaultMeters); }
        }
        window.__insideStart = insideStart; renderCharacterChooser();
        if(best){ $('#closest').textContent=best.name; $('#dist').textContent=`${best.d}`; $('#radius').textContent=`${best.radius}`; tryUnlock(best, accuracy); renderProgress(); renderStops(); updateLiveMap(latitude, longitude); }
        const st=store.get(); if(!st.lockedPc && !insideStart){ st.lockedPc=true; store.set(st); renderCharacterChooser(); toast('üîí Personage vergrendeld'); }
      }, err=>{ $('#permNote').innerHTML='<span class="warn">Locatie geweigerd</span>'; $('#geoState').textContent='Uit'; }, {enableHighAccuracy:true,maximumAge:10000,timeout:15000});
    }
    function stopWatch(){ if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; $('#geoState').textContent='Inactief'; } }

    // Safe binding helper
    const on=(id,ev,fn)=>{ const el=$(id.startsWith('#')?id:'#'+id); if(el) el.addEventListener(ev,fn); };

    function init(){
      // TTS voices
      if('speechSynthesis' in window){ try{pickVoice(); speechSynthesis.addEventListener('voiceschanged', pickVoice);}catch{} }
      // Routekaart
      try{ const rm=$('#routeMap'); if(rm) rm.src = DATA.meta.myMapsEmbedUrl; }catch{}

      ensureCharacter(); renderProfile(); renderStops(); renderUnlocked(); renderProgress();

      // Listeners (defensief)
      on('regenBtn','click',()=>{ const st=store.get(); if(st.lockedPc && !window.__insideStart){ toast('üîí Buiten startzone kan je niet wisselen.'); return; } delete st.pcId; store.set(st); ensureCharacter(); renderProfile(); renderUnlocked(); toast('üé≤ Nieuw personage gekozen'); });
      on('savePcBtn','click',()=>{ const st=store.get(); if(st.lockedPc && !window.__insideStart){ toast('üîí Wijzigen kan enkel aan de start.'); return; } if(!window.__insideStart){ toast('üîê Ga naar de startlocatie om te kiezen.'); return; } const sel=$('#pcSelect'); if(sel){ st.pcId=sel.value; store.set(st); renderProfile(); toast('‚úÖ Personage bevestigd'); }});
      on('exportBtn','click',()=>{ const st=store.get(); const pc=currentPc(); const lines=[]; lines.push(`# ${DATA.meta.title}`); lines.push(`Personage: ${pc.naam} (${pc.herkomst}) ‚Äì ${pc.rol}`); lines.push(''); for(const id of (st.unlocked||[])){ const stop=DATA.stops.find(s=>s.id===id); lines.push(`## ${stop?.naam||id}`); lines.push(pc.verhalen[id]||'(geen tekst)'); lines.push(''); } const blob=new Blob([lines.join('\n')],{type:'text/markdown'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='woi-voortgang.md'; a.click(); URL.revokeObjectURL(url); });
      on('unlockList','click',(e)=>{ const b=e.target.closest && e.target.closest('button.readBtn'); if(!b) return; const id=b.getAttribute('data-read'); const pc=currentPc(); const txt=pc?.verhalen?.[id]; if(txt){ if('speechSynthesis'in window && speechSynthesis.speaking){ speechSynthesis.cancel(); } else { speakText(txt); } }});
      on('startBtn','click',startWatch);
      on('stopBtn','click',stopWatch);
      on('demoBtn','click',()=>{ const s=DATA.stops.find(x=>x.id===DATA.meta.requiredStops[0])||DATA.stops[0]; tryUnlock({id:s.id,name:s.naam,d:0,radius:(s.radius||DATA.meta.radiusDefaultMeters)}); });
      on('resetBtn','click',()=>{ localStorage.removeItem('woi_state'); location.reload(); });

      // Install prompt
      let deferredPrompt=null; window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;const b=$('#installHint'); if(b){b.textContent='üì≤ Installeer app'; b.classList.add('primary');}}); 
      on('installHint','click',async()=>{ if(deferredPrompt){ deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; } else { alert('Installeer via browser-menu: Chrome: ‚ãÆ ‚Üí Toevoegen aan startscherm. Safari: Deel-icoon ‚Üí Zet op beginscherm.'); }});

      // SW
      if('serviceWorker' in navigator){
        navigator.serviceWorker.register('./sw.js?v=2025-08-31-clean1',{scope:'./'})
          .then(()=>{$('#cacheState').textContent='Ge√Ønstalleerd';})
          .catch(()=>{$('#cacheState').textContent='Niet ge√Ønstalleerd';});
      }

      // Debug overlay (toon met ?debug=1)
      if(new URLSearchParams(location.search).get('debug')==='1'){ const d=$('#diag'); d.style.display='block'; d.textContent='Boot OK ‚Ä¢ listeners actief'; }
    }

    document.addEventListener('DOMContentLoaded', init);
  })();
  </script>
</body>
</html>
