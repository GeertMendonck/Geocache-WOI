<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WOI â€“ Mijn Personage</title>
  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    :root{ --bg:#0b1220; --card:#121a2b; --muted:#8aa0c7; --text:#e6eefc; --accent:#98e3ff; --ok:#86efac; --warn:#fde68a; }
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 700px at 80% -10%,#13203c 0%, #0b1220 60%) fixed;color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:16px 16px 84px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:8px 0 16px}
    h1{font-size:1.2rem;margin:0}
    .badge{font-size:.8rem;color:#0b1220;background:var(--accent);padding:4px 8px;border-radius:999px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px 16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .muted{color:var(--muted)}
    button{appearance:none;border:1px solid rgba(255,255,255,.2);background:transparent;color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
    button.primary{background:var(--accent);color:#063245;border-color:transparent}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .kpi{display:flex;gap:10px;align-items:baseline}
    .kpi b{font-size:1.1rem}
    details{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px 12px}
    details+details{margin-top:8px}
    summary{cursor:pointer;font-weight:600}
    .pill{display:inline-block;border:1px solid rgba(255,255,255,.25);padding:2px 8px;border-radius:999px;margin:2px 6px 0 0;font-size:.8rem}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .small{font-size:.9rem}
    .foot{position:fixed;left:0;right:0;bottom:0;padding:8px 12px;background:linear-gradient(0deg,rgba(11,18,32,.92),rgba(11,18,32,.6));backdrop-filter:blur(8px);border-top:1px solid rgba(255,255,255,.08)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.14);padding:6px 10px;border-radius:999px}
    .sep{height:1px;background:rgba(255,255,255,.08);margin:8px 0}
  .ring{width:54px;height:54px;border-radius:999px;display:grid;place-items:center;background:conic-gradient(var(--accent) 0%, rgba(255,255,255,.15) 0% 100%);box-shadow:0 2px 8px rgba(0,0,0,.25)}
  .ring span{font-size:.75rem;color:#062b33;font-weight:700}
  .mapframe{width:100%;height:360px;border:0;border-radius:12px}
  .mapframe.small{height:300px}
  .qs{margin:.4rem 0 0 .2rem;padding-left:1rem}
  .qs li{margin:.2rem 0}
  .readBtn{margin-left:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>WOI â€“ Mijn Personage</h1>
      <span class=\"badge\">PWA â€¢ Offline<\/span><div class=\"ring\" id=\"progressRing\"><span id=\"progressText\">0\/0<\/span><\/div>
    </header>

    <div class="grid">
      <section class="card" id="profileCard">
        <h2 style="margin:.2rem 0 0">Jouw personage</h2>
        <div class="muted small">Je mag <b>alleen aan de startlocatie</b> een personage kiezen of wijzigen. Daarna wordt je keuze vastgezet.</div>
        <div id="pcInfo" style="margin-top:8px"></div>
        <div id="pcChooser" class="row small" style="margin-top:10px"></div>
        <div class="row" style="margin-top:10px">
          <button id="regenBtn">ğŸ² Willekeurig</button>
          <button id="savePcBtn" class="primary">âœ… Bevestig keuze</button>
          <button id="exportBtn">â¬‡ï¸ Exporteer voortgang</button>
        </div>
        <div class="sep"></div>
        <div class="small muted">Tip: installeer via menu (of knop hieronder) en open minstens Ã©Ã©n keer online; daarna werkt alles offline.</div>
      </section>

      <section class="card" id="statusCard">
        <h2>Locatiestatus</h2>
        <div class="row kpi"><div>ğŸ“ <b id="coords">â€”</b></div><div class="muted">(Â± <span id="acc">â€”</span> m)</div></div>
        <div class="row kpi"><div>ğŸ¯ Dichtstbijzijnde stop:</div><div><b id="closest">â€”</b></div></div>
        <div class=\"row kpi\"><div>â†”ï¸ Afstand:<\/div><div><b id=\"dist\">â€”<\/b> m<\/div><\/div>
        <div class=\"row kpi\"><div>ğŸ›¡ï¸ Straal:<\/div><div><b id=\"radius\">â€”<\/b> m<\/div><\/div>
        <div style="margin-top:8px" class="row">
          <button id="startBtn" class="primary">â–¶ï¸ Start locatie</button>
          <button id="stopBtn">â¸ï¸ Pauzeer</button>
          <button id="demoBtn">ğŸ§ª Demoâ€‘nabij</button>
        </div>
        <div id="permNote" class="small muted"></div>
      </section>
    </div>

    <section class="card" style="margin-top:12px">
      <h2>Ontgrendelde verhalen</h2>
      <div id="unlockList" class="small"></div>
    </section>

    <section class=\"card\" style=\"margin-top:12px\">
      <h2>Stops (overzicht)</h2>
      <div id=\"stopsList\" class=\"small\"></div>
    </section>

    <section class=\"card\" style=\"margin-top:12px\">
      <h2>Kaart</h2>
      <div class=\"small muted\">Routekaart (My Maps) en live positie (werkt online). Offline blijft de app functioneren zonder kaart.</div>
      <div class=\"grid\" style=\"grid-template-columns:1fr;gap:10px\">
        <iframe id=\"routeMap\" class=\"mapframe\" src=\"\"></iframe>
        <iframe id=\"liveMap\" class=\"mapframe small\" src=\"\"></iframe>
      </div>
      <div class=\"row small\" style=\"margin-top:8px\">
        <a id=\"openInMaps\" href=\"#\" target=\"_blank\" rel=\"noopener\">ğŸ“ Open je positie in Google Maps</a>
      </div>
    </section>
  </div>

  <div class="foot small">
    <div class="wrap" style="padding:0">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span class="chip">ğŸ“¦ <span class="mono" id="cacheState">Niet geÃ¯nstalleerd</span></span>
          <span class="chip">ğŸ›°ï¸ <span class="mono" id="geoState">Inactief</span></span>
        </div>
        <div class="row">
          <button id="installHint">ğŸ“² Installeer app</button>
          <button id="resetBtn">ğŸ§¹ Reset app</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scenario data -->
  <script id=\"scenario-data\" type=\"application/json\">{
    "meta": {
      "title": "WOI â€“ Mijn Personage",
      "radiusDefaultMeters": 200,
      "startStopId": "start_menenpoort",
      "endStopId": "end_menenpoort",
      "requiredStops": ["new_irish_farm","langemark","tyne_cot","passchendaele_museum"],
      "myMapsEmbedUrl": "https://www.google.com/maps/d/embed?mid=1PX9PLdEburE2dqbKbAj2C44SiCjtGSc&hl=nl&ehbc=2E312F"
    },
    "stops": [
      {"id":"start_menenpoort","naam":"Start: Menenpoort (Ieper)", "lat":50.851003, "lng":2.890939, "radius":140,
        "vragen":["Welke naam of inscriptie raakte je en waarom?","Wat verwacht je vandaag te leren?"]},
      {"id":"new_irish_farm","naam":"Stop 1: New Irish Farm Cemetery","lat":50.872890, "lng":2.897360, "radius":180,
        "vragen":["Wat viel je op aan de namen of symbolen op de graven?","Welke link hoor jij tussen dit landschap en het verhaal van jouw personage?"]},
      {"id":"langemark","naam":"Stop 2: Studentenfriedhof Langemark","lat":50.915300, "lng":2.916300, "radius":200,
        "vragen":["Wat betekent het voor jou dat hier vooral jonge studenten liggen?","Hoe verandert dit jouw kijk op â€˜de vijandâ€™?"]},
      {"id":"tyne_cot","naam":"Stop 3: Tyne Cot Cemetery","lat":50.887000, "lng":2.999300, "radius":220,
        "vragen":["Wat zegt de schaal van deze plek over de slag hier?","Welke zin uit het verhaal bleef hangen en waarom?"]},
      {"id":"passchendaele_museum","naam":"Stop 4: Memorial Museum Passchendaele","lat":50.898700, "lng":3.000700, "radius":180,
        "vragen":["Wat doet het met je om objecten uit de oorlog achter glas te zien?","Welke vraag zou jij willen stellen aan iemand uit die tijd?"]},
      {"id":"end_menenpoort","naam":"Einde: Menenpoort (Ieper)", "lat":50.851003, "lng":2.890939, "radius":140,
        "vragen":["Wat neem je mee uit de verhalen?","Voor wie wil jij hier even stilstaan?"]}
    ],
    "personages": []
  }</script>

  <script>
  // Helpers
  function distanceMeters(a,b){const R=6371e3;const Ï†1=a.lat*Math.PI/180,Ï†2=b.lat*Math.PI/180;const dÏ†=(b.lat-a.lat)*Math.PI/180;const dÎ»=(b.lng-a.lng)*Math.PI/180;const s=Math.sin(dÏ†/2)**2+Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(dÎ»/2)**2;return 2*R*Math.asin(Math.sqrt(s));}
  const $=sel=>document.querySelector(sel);
  const store={get(){try{return JSON.parse(localStorage.getItem('woi_state')||'{}')}catch{return {}}},set(v){localStorage.setItem('woi_state',JSON.stringify(v))}};
  const DATA=JSON.parse(document.getElementById('scenario-data').textContent);
  const urlParams=new URLSearchParams(location.search);
  function pick(arr){return arr[Math.floor(Math.random()*arr.length)]}

  // Personage
  function ensureCharacter(){
    const st=store.get();
    const forced=urlParams.get('pcId')||urlParams.get('pc');
    if(forced&&DATA.personages.some(p=>p.id===forced)){st.pcId=forced;st.unlocked=st.unlocked||[];store.set(st);return st.pcId;}
    if(st.pcId&&DATA.personages.some(p=>p.id===st.pcId))return st.pcId;
    const pc=pick(DATA.personages);st.pcId=pc.id;st.unlocked=st.unlocked||[];store.set(st);return pc.id;
  }
  function currentPc(){const id=store.get().pcId;return DATA.personages.find(p=>p.id===id)}

  function renderProfile(){
    const pc=currentPc(); if(!pc) return;
    $('#pcInfo').innerHTML = `<div class="row">
      <div class=\"pill\">ğŸ§‘ <b>${pc.naam}</b></div>
      <div class=\"pill\">ğŸ‚ ${pc.leeftijd} jaar</div>
      <div class=\"pill\">ğŸŒ ${pc.herkomst}</div>
      <div class=\"pill\">ğŸ–ï¸ ${pc.rol}</div>
    </div><p class=\"muted\">${pc.bio}</p>`;
    renderCharacterChooser();
  }
  function renderCharacterChooser(){
    const st=store.get();
    const chooser=$('#pcChooser');
    const options = DATA.personages.map(p=>`<option value=\"${p.id}\" ${p.id===st.pcId?'selected':''}>${p.naam} (${p.leeftijd}) â€” ${p.rol}</option>`).join('');
    const locked = !!st.lockedPc;
    const inside = window.__insideStart===true;
    chooser.innerHTML = `<select id=\"pcSelect\" ${locked?'disabled':''} ${!inside&&!locked?'disabled':''}>${options}</select>
      <span class=\"pill ${locked?'ok':''}\">${locked?'ğŸ”’ Keuze vergrendeld': (inside? 'ğŸŸ¢ Je kan hier je personage kiezen' : 'ğŸ” Kiesbaar enkel aan de start')}</span>`;
  }
  function renderStops(){
    const cont=$('#stopsList'); const st=store.get(); const unlocked=new Set(st.unlocked||[]);
    const reqSet=new Set(DATA.meta.requiredStops);
    const items = DATA.stops.map(s=>{
      const ok = unlocked.has(s.id);
      const isEnd = s.id===DATA.meta.endStopId;
      const icon = ok ? 'âœ…' : (isEnd ? 'ğŸ”’' : 'â³');
      return `<div class=\"pill\">${icon} ${s.naam}</div>`;
    }).join('');
    cont.innerHTML = items;
  }
  function renderUnlocked(){
    const st=store.get(); const pc=currentPc(); const cont=$('#unlockList');
    if(!st.unlocked||!st.unlocked.length){cont.innerHTML='<div class=\"muted\">Nog niets ontgrendeld.</div>';return;}
    cont.innerHTML = st.unlocked.map(id=>{
      const stop = DATA.stops.find(s=>s.id===id);
      const txt = pc.verhalen?.[id];
      const qs = (stop?.vragen||[]);
      const qHtml = qs.length? `<div class=\"small\" style=\"margin-top:6px\"><b>Reflectie:</b><ul class=\"qs\">${qs.map(q=>`<li>${q}</li>`).join('')}</ul></div>` : '';
      return `<details open>
        <summary>ğŸ“˜ ${stop?.naam||id}
          <button class=\"readBtn\" data-read=\"${id}\" title=\"Lees voor\">ğŸ”Š</button>
        </summary>
        <div style=\"margin-top:6px\">${txt||'<span class=muted>(Geen tekst)</span>'}</div>
        ${qHtml}
      </details>`;
    }).join('');
    renderProgress();
  }(){
    const st=store.get(); const pc=currentPc(); const cont=$('#unlockList');
    if(!st.unlocked||!st.unlocked.length){cont.innerHTML='<div class="muted">Nog niets ontgrendeld.</div>';return;}
    cont.innerHTML=st.unlocked.map(id=>{const stop=DATA.stops.find(s=>s.id===id);const txt=pc.verhalen[id];return `<details open><summary>ğŸ“˜ ${stop?.naam||id}</summary><div>${txt||'<span class=muted>(Geen tekst)</span>'}</div></details>`}).join('');
  }

  // Geoloc
  let watchId=null; window.__insideStart=false;
  function startWatch(){
    if(!('geolocation'in navigator)){ $('#permNote').textContent='Geen geolocatie'; return; }
    $('#geoState').textContent='Actief';
    watchId=navigator.geolocation.watchPosition(pos=>{
      const {latitude,longitude,accuracy}=pos.coords;
      $('#coords').textContent = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`; $('#acc').textContent=Math.round(accuracy);
      const here={lat:latitude,lng:longitude};
      let best=null; let insideStart=false;
      for(const s of DATA.stops){
        const d=Math.round(distanceMeters(here,{lat:s.lat,lng:s.lng}));
        if(!best||d<best.d) best={id:s.id,name:s.naam,d,radius:(s.radius||DATA.meta.radiusDefaultMeters)};
        if(s.id===DATA.meta.startStopId){ insideStart = d <= (s.radius||DATA.meta.radiusDefaultMeters); }
      }
      window.__insideStart = insideStart; renderCharacterChooser();
      if(best){ $('#closest').textContent=best.name; $('#dist').textContent=`${best.d}`; $('#radius').textContent = `${best.radius}`; tryUnlock(best, accuracy); renderProgress(); renderStops(); updateLiveMap(latitude, longitude); }
      const st=store.get(); if(!st.lockedPc && !insideStart){ st.lockedPc=true; store.set(st); renderCharacterChooser(); toast('ğŸ”’ Personage vergrendeld'); }
    }, err=>{ $('#permNote').innerHTML='<span class="warn">Locatie geweigerd</span>'; $('#geoState').textContent='Uit'; }, {enableHighAccuracy:true,maximumAge:10000,timeout:15000});
  }
  function stopWatch(){ if(watchId!==null){ navigator.geolocation.clearWatch(watchId); watchId=null; $('#geoState').textContent='Inactief'; } }

  function tryUnlock(best, acc){
    // Eerlijke-afstand: gebruik effectieve afstand = gemeten afstand - nauwkeurigheid
    const effective = Math.max(0, best.d - (acc||0));
    if(effective <= best.radius){
      const st=store.get(); st.unlocked=st.unlocked||[];
      if(best.id===DATA.meta.endStopId){
        const req = new Set(DATA.meta.requiredStops);
        const haveAll = [...req].every(id=>st.unlocked.includes(id));
        if(!haveAll){ return; }
      }
      if(!st.unlocked.includes(best.id)){
        st.unlocked.push(best.id); store.set(st);
        renderUnlocked(); toast(`âœ… Ontgrendeld: ${best.name}`);
      }
    }
  }
      }
      if(!st.unlocked.includes(best.id)){
        st.unlocked.push(best.id); store.set(st);
        renderUnlocked(); toast(`âœ… Ontgrendeld: ${best.name}`);
      }
    }
  }

  // Map helpers
  let lastMapAt=0; let lastLat=null, lastLng=null;
  function updateLiveMap(lat,lng){
    try{
      const now=Date.now(); const moved = !lastLat || distanceMeters({lat:lastLat,lng:lastLng},{lat,lng})>30;
      if(now-lastMapAt>8000 || moved){
        lastLat=lat; lastLng=lng; lastMapAt=now;
        const live = document.getElementById('liveMap'); if(live) live.src = `https://maps.google.com/maps?q=${lat},${lng}&z=15&output=embed`;
        const open = document.getElementById('openInMaps'); if(open) open.href = `https://maps.google.com/?q=${lat},${lng}`;
      }
    }catch{}
  }

  // Speech helpers
  let currentUtter=null; let selectedVoice=null;
  function pickVoice(){ try{ const voices = speechSynthesis.getVoices(); selectedVoice = voices.find(v=>v.lang && v.lang.toLowerCase().startsWith('nl')) || voices.find(v=>v.lang && v.lang.toLowerCase().startsWith('en')) || voices[0] || null; }catch{} }
  if('speechSynthesis' in window){ pickVoice(); try{ speechSynthesis.addEventListener('voiceschanged', pickVoice); }catch{} }
  function stopSpeak(){ try{ if('speechSynthesis' in window && speechSynthesis.speaking) speechSynthesis.cancel(); }catch{} }
  function speakText(text){
    if(!('speechSynthesis' in window)){ alert('Voorlezen wordt niet ondersteund op dit toestel.'); return; }
    stopSpeak(); const u = new SpeechSynthesisUtterance(text); if(selectedVoice) u.voice=selectedVoice; u.lang = (selectedVoice&&selectedVoice.lang) || 'nl-NL'; speechSynthesis.speak(u); currentUtter=u;
  }

  // UI helpers
  let toastTimer; function toast(msg){ clearTimeout(toastTimer); let t=document.getElementById('toast'); if(!t){ t=document.createElement('div'); t.id='toast'; document.body.appendChild(t);} t.textContent=msg; Object.assign(t.style,{position:'fixed',left:'50%',bottom:'76px',transform:'translateX(-50%)',background:'rgba(0,0,0,.75)',color:'#fff',padding:'10px 14px',borderRadius:'12px',zIndex:9999}); toastTimer=setTimeout(()=>{t.remove()},2600); }
  function exportProgress(){ const st=store.get(); const pc=currentPc(); const lines=[]; lines.push(`# ${DATA.meta.title}`); lines.push(`Personage: ${pc.naam} (${pc.herkomst}) â€“ ${pc.rol}`); lines.push(''); for(const id of (st.unlocked||[])){ const stop=DATA.stops.find(s=>s.id===id); lines.push(`## ${stop?.naam||id}`); lines.push(pc.verhalen[id]||'(geen tekst)'); lines.push(''); } const blob=new Blob([lines.join('\n')],{type:'text/markdown'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='woi-voortgang.md'; a.click(); URL.revokeObjectURL(url); }
  function hardReset(){ localStorage.removeItem('woi_state'); location.reload(); }

  // Events
  document.getElementById('startBtn').addEventListener('click',startWatch);
  document.getElementById('stopBtn').addEventListener('click',stopWatch);
  document.getElementById('regenBtn').addEventListener('click',()=>{ const st=store.get(); if(st.lockedPc && !window.__insideStart){ toast('ğŸ”’ Je kan je personage niet wijzigen buiten de startzone.'); return; } delete st.pcId; store.set(st); ensureCharacter(); renderProfile(); renderUnlocked(); toast('Nieuw personage gekozen'); });
  document.getElementById('savePcBtn').addEventListener('click',()=>{ const st=store.get(); if(st.lockedPc && !window.__insideStart){ toast('ğŸ”’ Personage wijzigen kan enkel aan de start.'); return; } if(!window.__insideStart){ toast('ğŸ” Ga naar de startlocatie om te kiezen.'); return; } const sel=document.getElementById('pcSelect'); if(sel){ st.pcId=sel.value; store.set(st); renderProfile(); toast('âœ… Personage bevestigd'); } });
  document.getElementById('exportBtn').addEventListener('click',exportProgress);
  document.getElementById('unlockList').addEventListener('click', (e)=>{ const b=e.target.closest('button[data-read]'); if(!b) return; const id=b.getAttribute('data-read'); const pc=currentPc(); const txt=pc?.verhalen?.[id]; if(txt) { if('speechSynthesis' in window && speechSynthesis.speaking){ stopSpeak(); } else { speakText(txt); } } });
  document.getElementById('resetBtn').addEventListener('click',hardReset);
  document.getElementById('demoBtn').addEventListener('click',()=>{ const s=DATA.stops.find(x=>x.id===DATA.meta.requiredStops[0])||DATA.stops[0]; tryUnlock({id:s.id,name:s.naam,d:0,radius:(s.radius||DATA.meta.radiusDefaultMeters)}); });

  // Install prompt
  let deferredPrompt=null; window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;const b=document.getElementById('installHint'); b.textContent='ğŸ“² Installeer app'; b.classList.add('primary');});
  document.getElementById('installHint').addEventListener('click',async()=>{ if(deferredPrompt){ deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; } else { alert('Installeer via browser-menu: Chrome: â‹® â†’ Toevoegen aan startscherm. Safari: deelâ€‘icoon â†’ Zet op beginscherm.'); } });

  // Service worker registratie
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js',{scope:'./'}).then(()=>{ $('#cacheState').textContent='GeÃ¯nstalleerd'; }).catch(()=>{ $('#cacheState').textContent='Niet geÃ¯nstalleerd'; }); }

  // Init
  ensureCharacter(); renderProfile(); renderStops(); renderUnlocked(); renderProgress();
  try{ const rm=document.getElementById('routeMap'); if(rm) rm.src = DATA.meta.myMapsEmbedUrl; }catch{}
  </script>
</body>
</html>
