<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WOI – Mijn Personage</title>
  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --muted:#8aa0c7; --text:#e6eefc; --accent:#98e3ff; --ok:#86efac; --warn:#fde68a;
    }
    html,body{height:100%;}
    body{margin:0;background:radial-gradient(1200px 700px at 80% -10%,#13203c 0%, #0b1220 60%) fixed; color:var(--text); font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .wrap{max-width:900px;margin:0 auto;padding:16px 16px 80px;}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:8px 0 16px}
    h1{font-size:1.2rem;margin:0}
    .badge{font-size:.8rem;color:#0b1220;background:var(--accent);padding:4px 8px;border-radius:999px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:14px 16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .muted{color:var(--muted)}
    button{appearance:none;border:1px solid rgba(255,255,255,.2);background:transparent;color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
    button.primary{background:var(--accent);color:#063245;border-color:transparent}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .kpi{display:flex;gap:10px;align-items:baseline}
    .kpi b{font-size:1.1rem}
    details{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px 12px}
    details+details{margin-top:8px}
    summary{cursor:pointer;font-weight:600}
    .pill{display:inline-block;border:1px solid rgba(255,255,255,.25);padding:2px 8px;border-radius:999px;margin:2px 6px 0 0;font-size:.8rem}
    .ok{color:var(--ok)}
    .warn{color:var(--warn)}
    .small{font-size:.9rem}
    .foot{position:fixed;left:0;right:0;bottom:0;padding:8px 12px;background:linear-gradient(0deg, rgba(11,18,32,.92), rgba(11,18,32,.6));backdrop-filter:blur(8px); border-top:1px solid rgba(255,255,255,.08)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.14);padding:6px 10px;border-radius:999px}
    .sep{height:1px;background:rgba(255,255,255,.08);margin:8px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>WOI – Mijn Personage</h1>
      <span class="badge">PWA • Offline</span>
    </header>

    <div class="grid">
      <section class="card" id="profileCard">
        <h2 style="margin:.2rem 0 0">Jouw personage</h2>
        <div class="muted small">Uniek toegewezen aan dit toestel (lokaal opgeslagen)</div>
        <div id="pcInfo" style="margin-top:8px"></div>
        <div class="row" style="margin-top:10px">
          <button id="regenBtn">🎲 Nieuw personage</button>
          <button id="exportBtn">⬇️ Exporteer voortgang</button>
        </div>
        <div class="sep"></div>
        <div class="small muted">Tip: installeer via menu (of knop hieronder) en open minstens één keer online; daarna werkt alles offline.</div>
      </section>

      <section class="card" id="statusCard">
        <h2>Locatiestatus</h2>
        <div class="row kpi"><div>📍 <b id="coords">—</b></div><div class="muted">(± <span id="acc">—</span> m)</div></div>
        <div class="row kpi"><div>🎯 Dichtstbijzijnde stop:</div><div><b id="closest">—</b></div></div>
        <div class="row kpi"><div>↔️ Afstand:</div><div><b id="dist">—</b> m</div></div>
        <div style="margin-top:8px" class="row">
          <button id="startBtn" class="primary">▶️ Start locatie</button>
          <button id="stopBtn">⏸️ Pauzeer</button>
          <button id="demoBtn">🧪 Demo‑nabij</button>
        </div>
        <div id="permNote" class="small muted"></div>
      </section>
    </div>

    <section class="card" style="margin-top:12px">
      <h2>Ontgrendelde verhalen</h2>
      <div id="unlockList" class="small"></div>
    </section>

    <section class="card" style="margin-top:12px">
      <h2>Stops (overzicht)</h2>
      <div id="stopsList" class="small"></div>
    </section>
  </div>

  <div class="foot small">
    <div class="wrap" style="padding:0">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span class="chip">📦 <span class="mono" id="cacheState">Niet geïnstalleerd</span></span>
          <span class="chip">🛰️ <span class="mono" id="geoState">Inactief</span></span>
        </div>
        <div class="row">
          <button id="installHint">📲 Installeer app</button>
          <button id="resetBtn">🧹 Reset app</button>
        </div>
      </div>
    </div>
  </div>

  <script id="scenario-data" type="application/json">{
    "meta": {"title": "WOI – Mijn Personage","radiusDefaultMeters": 200},
    "stops": [
      {"id":"menin_gate","naam":"Menin Gate (Ieper)", "lat":50.8510, "lng":2.8910, "radius":180},
      {"id":"tyne_cot","naam":"Tyne Cot Cemetery (Passendale)", "lat":50.8870, "lng":2.9993, "radius":220},
      {"id":"langemark","naam":"Duitse Militaire Begraafplaats Langemark","lat":50.9153, "lng":2.9163, "radius":200}
    ],
    "personages": [
      {"id":"youssef_ben_salah","naam":"Youssef ben Salah","herkomst":"Fès, Marokko","rol":"Tirailleur","bio":"Vrijwilliger uit Marokko, naar het Front gestuurd in 1917.","verhalen": {
        "menin_gate":"Bij de Menenpoort leest Youssef namen van vermisten…",
        "tyne_cot":"In Passendale ploeterde zijn compagnie door modder…",
        "langemark":"Na de slag wisselde Youssef voedsel met Duitse gevangenen…"
      }},
      {"id":"stanislaw_nowak","naam":"Stanisław Nowak","herkomst":"Galicië","rol":"Artilleriehelper","bio":"Boerenzoon, ingelijfd in 1915.","verhalen": {
        "menin_gate":"Stanisław begrijpt de stilte aan de Menenpoort…",
        "tyne_cot":"Hij hielp een 18‑ponder bedienen…",
        "langemark":"Tijdens een wapenstilte hoorde hij een viool…"
      }}
    ]
  }</script>

  <script>
  function distanceMeters(a,b){const R=6371e3;const φ1=a.lat*Math.PI/180,φ2=b.lat*Math.PI/180;const dφ=(b.lat-a.lat)*Math.PI/180;const dλ=(b.lng-a.lng)*Math.PI/180;const s=Math.sin(dφ/2)**2+Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2;return 2*R*Math.asin(Math.sqrt(s));}
  const $=sel=>document.querySelector(sel);
  const store={get(){try{return JSON.parse(localStorage.getItem('woi_state')||'{}')}catch{return {}}},set(v){localStorage.setItem('woi_state',JSON.stringify(v))}};
  const DATA=JSON.parse(document.getElementById('scenario-data').textContent);
  const urlParams=new URLSearchParams(location.search);
  function pick(arr){return arr[Math.floor(Math.random()*arr.length)]}

  function ensureCharacter(){
    const st=store.get();
    const forced=urlParams.get('pcId')||urlParams.get('pc');
    if(forced&&DATA.personages.some(p=>p.id===forced)){st.pcId=forced;st.unlocked=st.unlocked||[];store.set(st);return st.pcId;}
    if(st.pcId&&DATA.personages.some(p=>p.id===st.pcId))return st.pcId;
    const pc=pick(DATA.personages);st.pcId=pc.id;st.unlocked=st.unlocked||[];store.set(st);return pc.id;
  }
  function currentPc(){const id=store.get().pcId;return DATA.personages.find(p=>p.id===id)}

  function renderProfile(){const pc=currentPc();if(!pc)return;$('#pcInfo').innerHTML=`<div class="row"><div class="pill">🧑 <b>${pc.naam}</b></div><div class="pill">🌍 ${pc.herkomst}</div><div class="pill">🎖️ ${pc.rol}</div></div><p class="muted">${pc.bio}</p>`;}
  function renderStops(){const cont=$('#stopsList');cont.innerHTML=DATA.stops.map(s=>`<div class="pill">${s.naam}</div>`).join('');}
  function renderUnlocked(){const st=store.get();const pc=currentPc();const cont=$('#unlockList');if(!st.unlocked||!st.unlocked.length){cont.innerHTML='<div class="muted">Nog niets ontgrendeld.</div>';return;}cont.innerHTML=st.unlocked.map(id=>{const stop=DATA.stops.find(s=>s.id===id);const txt=pc.verhalen[id];return `<details open><summary>📘 ${stop?.naam||id}</summary><div>${txt||'<span class=muted>(Geen tekst)</span>'}</div></details>`}).join('');}

  let watchId=null;
  function startWatch(){if(!('geolocation'in navigator)){ $('#permNote').textContent='Geen geolocatie';return;}$('#geoState').textContent='Actief';watchId=navigator.geolocation.watchPosition(pos=>{const{latitude,longitude,accuracy}=pos.coords;$('#coords').textContent=`${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;$('#acc').textContent=Math.round(accuracy);const here={lat:latitude,lng:longitude};let best=null;for(const s of DATA.stops){const d=Math.round(distanceMeters(here,{lat:s.lat,lng:s.lng}));if(!best||d<best.d)best={id:s.id,name:s.naam,d,radius:(s.radius||DATA.meta.radiusDefaultMeters)};}if(best){$('#closest').textContent=best.name;$('#dist').textContent=`${best.d}`;tryUnlock(best);}},err=>{$('#permNote').innerHTML='<span class="warn">Locatie geweigerd</span>';$('#geoState').textContent='Uit';},{enableHighAccuracy:true,maximumAge:10000,timeout:15000});}
  function stopWatch(){if(watchId!==null){navigator.geolocation.clearWatch(watchId);watchId=null;$('#geoState').textContent='Inactief';}}

  function tryUnlock(best){if(best.d<=best.radius){const st=store.get();st.unlocked=st.unlocked||[];if(!st.unlocked.includes(best.id)){st.unlocked.push(best.id);store.set(st);renderUnlocked();toast(`✅ Ontgrendeld: ${best.name}`);}}}

  let toastTimer;function toast(msg){clearTimeout(toastTimer);let t=document.getElementById('toast');if(!t){t=document.createElement('div');t.id='toast';document.body.appendChild(t);}t.textContent=msg;Object.assign(t.style,{position:'fixed',left:'50%',bottom:'76px',transform:'translateX(-50%)',background:'rgba(0,0,0,.75)',color:'#fff',padding:'10px 14px',borderRadius:'12px',zIndex:9999});toastTimer=setTimeout(()=>{t.remove();},2600);}

  function exportProgress(){const st=store.get();const pc=currentPc();const lines=[];lines.push(`# ${DATA.meta.title}`);lines.push(`Personage: ${pc.naam} (${pc.herkomst}) – ${pc.rol}`);lines.push('');for(const id of(st.unlocked||[])){const stop=DATA.stops.find(s=>s.id===id);lines.push(`## ${stop?.naam||id}`);lines.push(pc.verhalen[id]||'(geen tekst)');lines.push('');}const blob=new Blob([lines.join('\n')],{type:'text/markdown'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='woi-voortgang.md';a.click();URL.revokeObjectURL(url);}
  function hardReset(){localStorage.removeItem('woi_state');location.reload();}

  document.getElementById('startBtn').addEventListener('click',startWatch);
  document.getElementById('stopBtn').addEventListener('click',stopWatch);
  document.getElementById('regenBtn').addEventListener('click',()=>{localStorage.removeItem('woi_state');ensureCharacter();renderProfile();renderUnlocked();toast('Nieuw personage');});
  document.getElementById('exportBtn').addEventListener('click',exportProgress);
  document.getElementById('resetBtn').addEventListener('click',hardReset);
  document.getElementById('demoBtn').addEventListener('click',()=>{const best=DATA.stops[0];tryUnlock({id:best.id,name:best.naam,d:0,radius:(best.radius||DATA.meta.radiusDefaultMeters)});});

  let deferredPrompt=null;
  window.addEventListener('beforeinstallprompt',(e)=>{e.preventDefault();deferredPrompt=e;const b=document.getElementById('installHint');b.textContent='📲 Installeer app';b.classList.add('primary');});
  document.getElementById('installHint').addEventListener('click',async()=>{if(deferredPrompt){deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;}else{alert('Installeer via menu van je browser: Chrome: ⋮ → Toevoegen aan startscherm. Safari: deel‑icoon → Zet op beginscherm.');}});

  if('serviceWorker'in navigator){navigator.serviceWorker.register('./sw.js',{scope:'./'}).then(()=>{document.getElementById('cacheState').textContent='Geïnstalleerd';}).catch(()=>{document.getElementById('cacheState').textContent='Niet geïnstalleerd';});}

  ensureCharacter();renderProfile();renderStops();renderUnlocked();
  </script>
</body>
</html>
